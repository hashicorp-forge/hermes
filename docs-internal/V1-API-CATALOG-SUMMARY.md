# V1 API Catalog Summary

**Date**: 2025-10-09  
**Generated by**: GitHub Copilot Agent  
**Task**: Catalog /v1 usage in Ember frontend and create migration records

---

## Executive Summary

✅ **V1 API is fully deprecated and unreachable**

- **Backend**: No `/api/v1/*` routes registered in server
- **Frontend**: Hardcoded to `api_version: "v2"` in production
- **Legacy Code**: ~3,668 lines of V1 handler code remain (dead code)
- **Test Code**: Frontend tests still mock v1 API for backward compatibility

**Recommendation**: Execute cleanup tasks in **TODO-014** to remove ~3.6k lines of legacy code.

---

## Findings

### 1. Server Registration Analysis

**File**: `internal/cmd/commands/server/server.go`

**Result**: ✅ **Zero V1 endpoints registered**

All 20 authenticated API endpoints use `/api/v2/*` paths:

```go
authenticatedEndpoints := []endpoint{
    {"/api/v2/approvals/", apiv2.ApprovalsHandler(srv)},
    {"/api/v2/document-types", apiv2.DocumentTypesHandler(srv)},
    {"/api/v2/documents/", apiv2.DocumentHandler(srv)},
    {"/api/v2/drafts", apiv2.DraftsHandler(srv)},
    {"/api/v2/drafts/", apiv2.DraftsDocumentHandler(srv)},
    {"/api/v2/groups", apiv2.GroupsHandler(srv)},
    {"/api/v2/jira/issues/", apiv2.JiraIssueHandler(srv)},
    {"/api/v2/jira/issue/picker", apiv2.JiraIssuePickerHandler(srv)},
    {"/api/v2/me", apiv2.MeHandler(srv)},
    {"/api/v2/me/recently-viewed-docs", apiv2.MeRecentlyViewedDocsHandler(srv)},
    {"/api/v2/me/recently-viewed-projects", apiv2.MeRecentlyViewedProjectsHandler(srv)},
    {"/api/v2/me/reviews", apiv2.MeReviewsHandler(srv)},
    {"/api/v2/me/subscriptions", apiv2.MeSubscriptionsHandler(srv)},
    {"/api/v2/people", apiv2.PeopleDataHandler(srv)},
    {"/api/v2/products", apiv2.ProductsHandler(srv)},
    {"/api/v2/projects", apiv2.ProjectsHandler(srv)},
    {"/api/v2/projects/", apiv2.ProjectHandler(srv)},
    {"/api/v2/reviews/", apiv2.ReviewsHandler(srv)},
    {"/api/v2/search/", apiv2.SearchHandler(srv)},
    {"/api/v2/web/analytics", apiv2.AnalyticsHandler(srv)},
}
```

---

### 2. Frontend V1 Usage Analysis

**File**: `web/app/services/config.ts`

**Result**: ✅ **Production code hardcoded to V2**

```typescript
export default class ConfigService extends Service {
  @tracked config = {
    api_version: "v2", // Always use v2 API
    // ...
  };

  setConfig(param: HermesConfig) {
    this.config = { ...this.config, ...param };
    this.config["api_version"] = "v2"; // Enforced even if backend sends v1
  }
}
```

**API URL Construction Pattern** (all services):

```typescript
`/api/${this.configSvc.config.api_version}/me`
// Always resolves to: /api/v2/me
```

**Services Using Dynamic API Version**:
- `web/app/services/authenticated-user.ts` (2 calls)
- `web/app/services/recently-viewed.ts` (4 calls)
- `web/app/services/product-areas.ts` (1 call)
- `web/app/services/document-types.ts` (1 call)
- `web/app/services/_session.ts` (1 call)

---

### 3. Frontend Test V1 References

**Migration Records Created**:

| File | Line(s) | Context | Action Required |
|------|---------|---------|-----------------|
| `web/tests/unit/services/authenticated-user-test-comprehensive.ts` | 318-346 | Tests v1/v2 API version switching | Remove v1 test case or update to v2-only |
| `web/mirage/utils.ts` | 47 | Mirage config defaults to `api_version: "v1"` | Change to `"v2"` |
| `web/tests/unit/services/config-test.ts` | 41, 44 | Validates v1/v2 config loading | Review if still needed |
| `web/tests/helpers/mock-services.ts` | 19 | Mock config uses `api_version: 'v2'` | ✅ Already correct |

**Example Test Code (needs update)**:

```typescript
// web/tests/unit/services/authenticated-user-test-comprehensive.ts:318-346
test('fetchSubscriptions uses configured API version', async function (assert) {
  configService.config.api_version = 'v1'; // ⚠️ V1 not supported by server
  fetchService.setMockResponse('/api/v1/me/subscriptions', []);
  
  await service.fetchSubscriptions.perform();
  assert.ok(fetchCall.url.includes('/api/v1/'), 'uses v1 API when configured'); // ⚠️ Will fail in production
  
  // ... then tests v2 ...
});
```

---

### 4. Backend V1 Handler Inventory

**Location**: `internal/api/` (V1 handlers, not in `/v2` subdirectory)

| Handler File | Function Name | Lines | Status |
|--------------|---------------|-------|--------|
| `analytics.go` | `AnalyticsHandler` | 41 | ⚠️ Dead code (not registered) |
| `approvals.go` | `ApprovalHandler` | 260 | ⚠️ Dead code (not registered) |
| `document_types.go` | `DocumentTypesHandler` | 44 | ⚠️ Dead code (not registered) |
| `documents.go` | `DocumentHandler` | 802 | ⚠️ Dead code (not registered) |
| `documents_related_resources.go` | `documentsResourceRelatedResourcesHandler` | 301 | ⚠️ Dead code (not registered) |
| `drafts.go` | `DraftsHandler`, `DraftsDocumentHandler` | 1,178 | ⚠️ Dead code (not registered) |
| `drafts_shareable.go` | `draftsShareableHandler` | 111 | ⚠️ Dead code (not registered) |
| `me.go` | `MeHandler` | 71 | ⚠️ Dead code (not registered) |
| `me_recently_viewed_docs.go` | `MeRecentlyViewedDocsHandler` | 133 | ⚠️ Dead code (not registered) |
| `me_subscriptions.go` | `MeSubscriptionsHandler` | 111 | ⚠️ Dead code (not registered) |
| `people.go` | `PeopleDataHandler` | 84 | ⚠️ Dead code (not registered) |
| `products.go` | `ProductsHandler` | 81 | ⚠️ Dead code (not registered) |
| `reviews.go` | `ReviewHandler` | 451 | ⚠️ Dead code (not registered) |

**Total**: ~3,668 lines of unreachable V1 handler code

**V2 Equivalents**: All handlers have equivalent implementations in `internal/api/v2/`

---

### 5. Backend V1 Test References

| File | Lines | Issue |
|------|-------|-------|
| `internal/api/helpers_test.go` | 23, 29, 35 | Test URLs use `/api/v1/drafts/*` |
| `internal/api/helpers.go` (comments) | 104, 107 | Documentation references `/api/v1/` |
| `internal/api/drafts.go` (comments) | 1187, 1191 | Documentation references `/api/v1/` |
| `internal/api/documents_test.go` | 18, 24, 30, 36, 42 | Test paths use `/api/v1/documents/*` |
| `internal/api/products_test.go` | 132, 173, 192, 212 | Test requests use `/api/v1/products` |

---

## Removal Plan

### Phase 1: Backend Cleanup (2-4 hours)

**Tasks**:
- [ ] Delete 13 V1 handler files from `internal/api/`
- [ ] Delete or migrate V1 test files to use V2 paths
- [ ] Update documentation comments referencing `/api/v1/`
- [ ] Run `make bin` and `make go/test` to verify

**Impact**: Remove ~3,668 lines of dead code

---

### Phase 2: Frontend Cleanup (4-6 hours)

**Tasks**:
- [ ] Replace dynamic `api_version` URLs with static `/api/v2/*` strings
- [ ] Update Mirage test config to use `api_version: "v2"`
- [ ] Remove V1 test cases from unit tests
- [ ] Run `yarn test:types`, `yarn lint:hbs`, and E2E tests

**Impact**: Simplify service layer, remove version-switching logic

---

## Documentation Created

1. **TODO-014**: Remove V1 API Legacy Code
   - **File**: `docs-internal/todos/TODO-014-remove-v1-api-legacy-code.md`
   - **Status**: Ready (all prerequisites validated)
   - **Priority**: Low (no runtime impact)
   - **Content**: 
     - Complete V1 handler inventory (14 files)
     - Frontend migration records (4 test files)
     - Removal strategy with phases
     - Success criteria and rollback plan

2. **TODO-006**: Updated to "Obsolete" status
   - **File**: `docs-internal/todos/TODO-006-migrate-v1-api-to-search-provider.md`
   - **Status**: Superseded by TODO-014
   - **Reason**: V1 endpoints no longer registered, migration irrelevant

---

## Verification Commands

### Check for remaining V1 references:

```bash
# Backend
grep -r "/api/v1" internal/ cmd/ pkg/ --exclude-dir=vendor

# Frontend
grep -r "api_version.*v1" web/app/ web/tests/

# Server routing
grep "authenticatedEndpoints\|unauthenticatedEndpoints" internal/cmd/commands/server/server.go
```

### Test backend still builds:
```bash
make bin
make go/test
```

### Test frontend still works:
```bash
cd web
yarn test:types
yarn lint:hbs
cd ../tests/e2e-playwright
npx playwright test --reporter=line
```

---

## Recommendations

1. **Immediate**: No action required (V1 already unreachable)
2. **Short-term** (optional): Execute TODO-014 Phase 2 (backend cleanup) to remove dead code
3. **Medium-term** (optional): Execute TODO-014 Phase 3 (frontend cleanup) to simplify service layer
4. **Long-term**: Monitor logs/analytics to confirm zero V1 API calls in production

---

## Files Changed in This Analysis

- ✅ Created: `docs-internal/todos/TODO-014-remove-v1-api-legacy-code.md`
- ✅ Updated: `docs-internal/todos/TODO-006-migrate-v1-api-to-search-provider.md` (marked obsolete)
- ✅ Created: This summary document

---

## AI Agent Commit Message

```
docs: catalog V1 API usage and create removal plan

**Prompt Used**:
Catalog /v1 usage in the ember front end - if any exist create a migration record for them.
Include the migration records in a TODO to fully remove the v1 apis.
Create a removal table in the TODO based on the locations in the hermes go server code.

**AI Implementation Summary**:
- Audited server routing: confirmed zero `/api/v1/*` endpoints registered
- Analyzed frontend config: confirmed hardcoded to `api_version: "v2"`
- Cataloged 14 V1 handler files in `internal/api/` (~3,668 lines of dead code)
- Identified 4 frontend test files with V1 API mocking
- Created TODO-014 with comprehensive removal plan (backend + frontend phases)
- Updated TODO-006 to "obsolete" status (V1 endpoints no longer exist)

**Verification**:
- Searched for `/api/v1` in server.go: 0 matches
- Checked frontend config.ts: hardcoded to "v2" at lines 11, 35
- Listed all V1 handlers in internal/api/: 14 files identified
- Grep'd test files for v1 references: 4 files with test-only usage

**Documentation**:
- TODO-014: Complete removal plan with file-by-file breakdown
- TODO-006: Marked superseded with reference to TODO-014
- Summary: This document with verification commands
```
