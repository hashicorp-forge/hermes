name: Trigger Deploy

on:
  push:
    branches: [main]
    workflow_dispatch: {}

jobs:
  trigger-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      - name: Set git short
        id: git_short_var
        run: |
          echo "github_sha_short=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT
      
      - name: Debug - Test token authentication
        run: |
          echo "Testing GitHub token authentication..."
          response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer ${{secrets.HERMES_GH_SVC_ACCESS_TOKEN}}" https://api.github.com/user)
          http_code="${response: -3}"
          echo "Auth test HTTP code: $http_code"
          if [ "$http_code" = "200" ]; then
            echo "✅ Token authentication successful"
          else
            echo "❌ Token authentication failed"
          fi

      - name: Debug - Test repository access
        run: |
          echo "Testing repository access..."
          repo_name="${{secrets.HERMES_DEPLOY_TRIGGER_REPOSITORY_NAME}}"
          echo "Testing access to repository: ${repo_name}"
          response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer ${{secrets.HERMES_GH_SVC_ACCESS_TOKEN}}" https://api.github.com/repos/${repo_name})
          http_code="${response: -3}"
          echo "Repository access HTTP code: $http_code"
          if [ "$http_code" = "200" ]; then
            echo "✅ Repository accessible"
          else
            echo "❌ Repository not accessible - Check repository name and permissions"
            echo "Response body: ${response%???}"
          fi

      - name: Debug - Test dispatches endpoint
        run: |
          echo "Testing dispatches endpoint access..."
          repo_name="${{secrets.HERMES_DEPLOY_TRIGGER_REPOSITORY_NAME}}"
          response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer ${{secrets.HERMES_GH_SVC_ACCESS_TOKEN}}" https://api.github.com/repos/${repo_name}/dispatches)
          http_code="${response: -3}"
          echo "Dispatches endpoint HTTP code: $http_code"
          if [ "$http_code" = "422" ] || [ "$http_code" = "204" ]; then
            echo "✅ Dispatches endpoint accessible (422/204 expected for GET)"
          else
            echo "❌ Dispatches endpoint not accessible"
            echo "Response body: ${response%???}"
          fi

      - name: trigger workflow
        run: |
          curl -X POST -H 'Authorization: Bearer ${{secrets.HERMES_GH_SVC_ACCESS_TOKEN}}' -H 'Accept: application/vnd.github+json' -H 'X-GitHub-Api-Version: 2022-11-28' https://api.github.com/repos/${{secrets.HERMES_DEPLOY_TRIGGER_REPOSITORY_NAME}}/dispatches --data '{"event_type": "hermes_merge_to_main","client_payload":{"github_sha": "${{ github.sha }}","github_sha_short": "${{ steps.git_short_var.outputs.github_sha_short }}","message": "${{ github.repository }} - ${{ steps.git_short_var.outputs.github_sha_short }}"}}'
