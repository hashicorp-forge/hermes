{{on-document "keydown" this.onDocumentKeydown}}

<div class="w-full">
  <div class="relative z-10 flex items-center w-full justify-between">
    <div class="hds-typography-body-100 hds-foreground-faint">
      Related resources
    </div>
    <Action
      class="flex items-center ml-px -mr-px px-1 py-1 rounded border hover:border-color-border-strong"
      {{on "click" this.showModal}}
    >
      <FlightIcon @name="plus" />
    </Action>
  </div>

  {{! TODO: move this out of the component }}

  {{#if this.relatedResourcesAreShown}}

    <AnimatedContainer class="w-full">
      <ul class="!mt-0.5 related-docs">
        {{#animated-each
          this.relatedResourcesObjectEntries
          use=this.transition
          initialInsertion=true
          finalRemoval=true
          as |resource|
        }}
          <li
            class="flex w-full relative group related-docs-list-item
              {{if resource.objectID 'hermes-doc' 'external-doc'}}"
          >
            {{! TODO: figure out animation }}

            <div class="w-full related-doc-link-container">
              {{#if resource.objectID}}
                <LinkTo
                  @route="authenticated.document"
                  @model={{resource.objectID}}
                  class="related-doc-link"
                >
                  <div
                    class="shrink-0 p-px hds-surface-mid rounded-sm flex mt-1 overflow-hidden bg-white"
                  >
                    <img src="/images/document.png" class="w-5 h-auto" />
                  </div>
                  <div class="w-full overflow-hidden pr-6">
                    <h4 class="inline-doc-title mb-0.5 truncate">
                      {{resource.title}}
                    </h4>
                    {{#if resource.docNumber}}
                      <div class="text-color-foreground-faint text-body-100">
                        {{resource.docNumber}}
                      </div>
                    {{/if}}
                  </div>
                </LinkTo>

              {{else}}
                <ExternalLink
                  href={{resource.url}}
                  class="related-doc-link py-0.5 flex pr-6 w-full"
                >
                  <div class="flex items-center w-full">
                    <div class="flex relative mr-2 w-4 h-4 shrink-0">
                      <img
                        src="https://www.google.com/s2/favicons?domain={{resource.url}}"
                        width="16"
                        height="16"
                      />
                    </div>
                    <div class="w-full pr-6">
                      <div class="truncate inline-doc-title">
                        {{resource.title}}
                      </div>

                      <div
                        class="truncate text-body-100 text-color-foreground-faint"
                      >
                        {{resource.displayURL}}
                      </div>
                    </div>
                  </div>
                </ExternalLink>
              {{/if}}

              {{! This needs to be outside the LinkTo }}
              <Inputs::DocumentSelect::MoreButton
                @removeResource={{this.removeResource}}
                @resource={{resource}}
              />
            </div>
          </li>
        {{/animated-each}}
      </ul>

    </AnimatedContainer>

  {{else}}
    <div class="mt-1.5 text-color-foreground-faint">
      ---
    </div>
  {{/if}}

</div>

{{#if this.modalIsShown}}
  {{#in-element (html-element ".ember-application") insertBefore=null}}
    <Hds::Modal @onClose={{this.hideModal}} class="h-[475px]" as |M|>
      <M.Header>
        <div class="flex w-full items-center">

          {{#if this.ediXXtModeIsEnabled}}
            <Action
              {{on "click" this.disableEditMode}}
              class="flex items-center"
            >
              <FlightIcon
                @name="arrow-left"
                class="text-color-foreground-faint mr-4"
              />
            </Action>
          {{/if}}
          <div class="{{if this.edXXitModeIsEnabled 'text-center'}} w-full">

            {{if
              this.edXXitModeIsEnabled
              "Add external resource"
              "Add resource"
            }}
          </div>
        </div>
      </M.Header>
      <M.Body>
        <div class="">

          <X::DropdownList
            @items={{this.shownDocuments}}
            @onItemClick={{this.addRelatedDocument}}
            @inputVisibility="hidden"
            @offset={{hash mainAxis=1 crossAxis=0}}
            @isLoading={{this.loadInitialData.isRunning}}
            @placement="none"
            @disableClose={{true}}
            @listIsHidden={{this.queryIsThirdPartyURL}}
            class="w-full max-w-none relative modal-list"
          >
            <:anchor as |dd|>
              {{!-- <Hds::Form::TextInput::Base
                @type="text"
                @value={{this.title}}
                disabled={{not this.editModeIsEnabled}}
                class="mb-2"
                  placeholder="Title"
              /> --}}

              <Hds::Form::TextInput::Base
                data-test-global-search-input
                {{did-insert dd.registerAnchor}}
                {{did-insert (fn this.didInsertInput dd)}}
                {{on "input" (fn this.onInput dd)}}
                {{on "keydown" (fn this.onInputKeydown dd)}}
                {{on "focusin" (fn this.maybeOpenDropdown dd)}}
                @type="search"
                @value={{this.query}}
                size="25"
                placeholder="Paste a URL or search documents..."
                aria-label="Paste a URL or search documents..."
                aria-controls={{dd.ariaControls}}
                aria-expanded={{dd.contentIsShown}}
                aria-haspopup="listbox"
                class={{if this.edXXitModeIsEnabled "hidden"}}
              />
            </:anchor>
            <:header>
              {{#unless this.editModeIsEnabled}}
                {{#unless this.fetchURLInfo.isRunning}}
                  <div
                    class="mt-3.5 px-3 text-color-foreground-faint uppercase tracking-wide font-medium text-[12px]"
                  >
                    {{#if this.query.length}}
                      Results
                    {{else}}
                      Suggestions
                    {{/if}}
                  </div>
                {{/unless}}
              {{/unless}}
              <div
                class="relative
                  {{if
                    (and this.queryIsThirdPartyURL (not this.editModeIsEnabled))
                    'text-center pt-28'
                  }}"
              >
                {{#if
                  (and this.queryIsThirdPartyURL (not this.editModeIsEnabled))
                }}
                  <FlightIcon @name="loading" @size="24" />
                {{/if}}

                {{#if (and this.queryIsThirdPartyURL this.editModeIsEnabled)}}
                  <div class="px-3 w-full">

                    <div
                      class="mt-6 px-3 mb-4 w-full bg-color-surface-interactive-hover pt-7 pb-10 rounded-lg"
                    >
                      {{! <div class="relative inline-flex mb-1.5">
                      <div
                        class="doc-thumbnail mx-auto bg-white w-12 h-[62px] grid place-items-center relative"
                      >
                        <FlightIcon
                          @name="globe"
                          @size="24"
                          class="text-color-foreground-faint"
                        />
                      </div>
                      <div
                        class="absolute top-1.5 -right-6 text-color-foreground-faint bg-gradient-to-br from-color-palette-neutral-400 to-color-palette-neutral-300 w-7 h-7 rounded-full grid place-items-center z-10"
                      >
                        <FlightIcon @name="figma" class="text-white" />
                      </div>
                    </div> }}
                      <div
                        class="text-display-300 w-full text-color-foreground-primary font-semibold"
                      >
                        <div class="flexX gap-4 items-center mb-2.5 px-8">
                          <div
                            class="text-color-foreground-faint uppercase tracking-wide font-medium text-[12px] mb-2"
                          >
                            External resource
                          </div>
                          {{!-- <label
                            {{! TODO: semantics }}
                            class="hermes-form-label mb-1 shrink-0 w-12"
                          >
                            Title
                          </label> --}}
                          <Hds::Form::TextInput::Base
                            {{on "input" this.onExternalLinkTitleInput}}
                            @value={{this.externalLinkTitle}}
                            class="text-display-300 font-semibold h-11 px-2.5"
                          />
                        </div>
                      </div>
                      <div class="flexX w-full gap-4 items-center mb-5 px-8">
                        {{!-- <label
                        {{! TODO: semantics }}
                        class="hermes-form-label mb-1 shrink-0 w-12"
                      >
                        URL
                      </label> --}}
                        <div
                          class="relative w-full pl-6 text-color-foreground-faint"
                        >
                          <div class="truncate">{{this.query}}</div>
                          <div
                            class="absolute left-0 top-1/2 -translate-y-1/2 w-4 h-4"
                          >
                            {{#if this.defaultFaviconIsShown}}
                              <FlightIcon @name="globe" />
                            {{else}}
                              <img
                                src={{this.faviconURL}}
                                width="16"
                                height="16"
                              />
                            {{/if}}
                          </div>
                        </div>
                      </div>
                      <div class="px-8 w-full">
                        <Hds::Button
                          @color="primary"
                          @text="Add"
                          @isFullWidth={{true}}
                          {{on "click" this.addRelatedExternalLink}}
                        />
                      </div>
                    </div>
                  </div>
                {{/if}}
              </div>
            </:header>
            <:loading>
              <FlightIcon @name="loading" class="ml-2 mt-4" />
            </:loading>
            <:item as |dd|>
              <dd.Action
                class="w-full flex items-center justify-between py-1.5 px-3 rounded h-[74px]"
              >
                <div class="flex w-full overflow-hidden space-x-3 relative">
                  <Doc::Thumbnail
                    @status={{dd.attrs.status}}
                    @product={{dd.attrs.product}}
                    class="shrink-0 w-12 h-[62px]"
                  />
                  <div class="w-full overflow-hidden pr-8 flex items-center">
                    <div>
                      <h4
                        class="text-display-300 font-semibold text-color-foreground-strong pr-0.5 truncate"
                      >
                        {{dd.attrs.title}}
                      </h4>
                      <div
                        class="text-color-foreground-faint text-body-200 flex space-x-3"
                      >
                        <span>
                          {{get dd.attrs.owners 0}}
                        </span>
                      </div>
                      {{#if dd.attrs.docNumber}}
                        <span class="absolute right-0 top-0">
                          {{dd.attrs.docNumber}}
                        </span>
                      {{/if}}
                    </div>
                  </div>
                </div>
              </dd.Action>
            </:item>
          </X::DropdownList>
        </div>

      </M.Body>
      {{#if this.eXditModeIsEnabled}}
        <M.Footer>

          <Hds::Button
            @color="primary"
            @text="Save and add"
            @isFullWidth={{true}}
            {{on "click" this.addRelatedExternalLink}}
          />

        </M.Footer>
      {{/if}}
    </Hds::Modal>
  {{/in-element}}
{{/if}}
