{{on-document "keydown" this.onDocumentKeydown}}
<div class="w-full">
  <div class="relative z-10 flex items-center w-full justify-between">
    <div class="hds-typography-body-100 hds-foreground-faint">
      Related resources
    </div>
    <Action
      class="flex items-center ml-px -mr-px px-1 py-1 rounded border hover:border-color-border-strong"
      {{on "click" this.showModal}}
    >
      <FlightIcon @name="plus" />
    </Action>
  </div>
</div>

{{#if this.modalIsShown}}
  {{#in-element (html-element ".ember-application") insertBefore=null}}
    <Hds::Modal @onClose={{this.hideModal}} class="h-[475px]" as |M|>
      <M.Header>
        <div class="flex w-full items-center">

          {{#if this.editModeIsEnabled}}
            <Action
              {{on "click" this.disableEditMode}}
              class="flex items-center"
            >
              <FlightIcon
                @name="arrow-left"
                class="text-color-foreground-faint mr-4"
              />
            </Action>
          {{/if}}
          <div class="{{if this.editModeIsEnabled 'text-center'}} w-full">

            {{if this.editModeIsEnabled "Edit resource" "Add resource"}}
          </div>
        </div>
      </M.Header>
      <M.Body>
        <div>

          <X::DropdownList
            @items={{this.shownDocuments}}
            @onItemClick={{this.addRelatedDocument}}
            @inputVisibility="hidden"
            @offset={{hash mainAxis=1 crossAxis=0}}
            @isLoading={{this.loadInitialData.isRunning}}
            @placement="none"
            @disableClose={{true}}
            @listIsHidden={{this.inputValueIsValid}}
            class="w-full max-w-none relative modal-list"
          >
            <:anchor as |dd|>

              <Hds::Form::TextInput::Base
                data-test-global-search-input
                {{did-insert dd.registerAnchor}}
                {{did-insert (fn this.didInsertInput dd)}}
                {{on "input" (fn this.onInput dd)}}
                {{on "keydown" (fn this.onInputKeydown dd)}}
                {{on "focusin" (fn this.maybeOpenDropdown dd)}}
                @type="search"
                @value={{this.query}}
                size="25"
                placeholder="Paste a URL or search documents..."
                aria-label="Paste a URL or search documents..."
                aria-controls={{dd.ariaControls}}
                aria-expanded={{dd.contentIsShown}}
                aria-haspopup="listbox"
                class={{if this.editModeIsEnabled "hidden"}}
              />
            </:anchor>
            <:header>
              {{! TODO: improve this logic }}
              {{#unless this.editModeIsEnabled}}
                <div
                  class="mt-3.5 px-3 text-color-foreground-faint uppercase tracking-wide font-medium text-[12px]"
                >
                  {{#if this.query.length}}
                    {{#if this.inputValueIsValid}}
                      External link
                    {{else}}
                      Results
                    {{/if}}
                  {{else}}
                    Suggestions
                  {{/if}}
                </div>
              {{/unless}}
              <div class="relative">

                {{#if this.inputValueIsValid}}
                  <Action
                    {{on "click" this.maybeAddRelatedExternalLink}}
                    class="mt-1 px-3 mb-4 w-full py-1.5 items-center
                      {{unless
                        this.editModeIsEnabled
                        'h-[74px] rounded-md bg-color-surface-interactive-hover'
                      }}"
                  >
                    <div class="flex relative h-full items-center">
                      <div class="w-full h-full">
                        <div
                          class="w-full h-full
                            {{unless
                              this.editModeIsEnabled
                              'flex justify-between items-center'
                            }}"
                        >
                          {{#unless this.editModeIsEnabled}}
                            <div
                              class="{{if this.editModeIsEnabled 'w-full mb-5'}}
                                shrink-0 mr-3"
                            >

                              {{#if this.faviconIsShown}}
                                <div
                                  class="doc-thumbnail bg-white w-12 h-[62px] grid place-items-center"
                                >
                                  <FlightIcon
                                    @name="globe"
                                    @size="24"
                                    class="text-color-foreground-faint"
                                  />
                                </div>
                              {{else}}
                                <FlightIcon @name="loading" />
                              {{/if}}
                            </div>
                          {{/unless}}

                          <div class="w-full">
                            <div
                              class="flex items-center space-x-2 text-display-300 text-color-foreground-primary font-semibold"
                            >
                              {{#if this.editModeIsEnabled}}
                                <Hds::Form::TextInput::Field
                                  @value={{this.externalLinkTitle}}
                                  class="mb-4 text-display-300"
                                  as |F|
                                >
                                  <F.Label>
                                    Title
                                  </F.Label>
                                </Hds::Form::TextInput::Field>
                              {{else}}
                                <div>
                                  {{unless
                                    this.fetchURLInfo.isRunning
                                    this.externalLinkTitle
                                  }}
                                </div>
                              {{/if}}
                            </div>
                            {{#if this.editModeIsEnabled}}
                              <Hds::Form::TextInput::Field
                                @value={{this.query}}
                                class="mb-4"
                                as |F|
                              >
                                <F.Label>
                                  URL
                                </F.Label>
                              </Hds::Form::TextInput::Field>

                              {{! <div class="hermes-form-label mb-2">
                                Icon
                              </div>
                              <div
                                class="doc-thumbnail bg-white w-12 h-[62px] grid place-items-center"
                              >
                                <FlightIcon
                                  @name="globe"
                                  @size="24"
                                  class="text-color-foreground-faint"
                                />
                              </div> }}
                            {{else}}
                              <div
                                class="text-body-200 text-color-foreground-faint"
                              >
                                {{unless
                                  this.fetchURLInfo.isRunning
                                  this.displayURL
                                }}
                              </div>
                            {{/if}}
                          </div>
                          {{#unless this.editModeIsEnabled}}
                            <div class="shrink-0 flex ml-2 mr-3.5">
                              <FlightIcon
                                @name="plus"
                                @size="24"
                                class="text-color-foreground-faint plus"
                              />
                            </div>
                          {{/unless}}
                        </div>
                      </div>
                    </div>
                  </Action>
                {{/if}}
              </div>
            </:header>
            <:loading>
              <FlightIcon @name="loading" class="ml-2 mt-4" />
            </:loading>
            <:item as |dd|>
              <dd.Action
                class="w-full flex items-center justify-between py-1.5 px-3 rounded h-[74px]"
              >
                <div class="flex w-full overflow-hidden space-x-3 relative">
                  <Doc::Thumbnail
                    @status={{dd.attrs.status}}
                    @product={{dd.attrs.product}}
                    class="shrink-0 w-12 h-[62px]"
                  />
                  <div class="w-full overflow-hidden pr-8 flex items-center">
                    <div>

                      <h4
                        class="text-display-300 font-semibold text-color-foreground-strong pr-0.5 truncate"
                      >
                        {{dd.attrs.title}}
                      </h4>
                      <div
                        class="text-color-foreground-faint text-body-200 flex space-x-3"
                      >
                        {{log dd.attrs}}
                        {{!--
                      {{#if dd.attrs.docType}}
                        <span>{{dd.attrs.docType}}</span>
                      {{/if}} --}}
                        <span>
                          {{get dd.attrs.owners 0}}
                        </span>
                      </div>
                      {{#if dd.attrs.docNumber}}
                        <span class="absolute right-0 top-0">
                          {{dd.attrs.docNumber}}
                        </span>
                      {{/if}}
                    </div>
                  </div>
                </div>
              </dd.Action>
            </:item>
          </X::DropdownList>
        </div>

      </M.Body>
      {{#if this.editModeIsEnabled}}
        <M.Footer>

          <Hds::Button
            @color="primary"
            @text="Save and add"
            {{on "click" this.addRelatedExternalLink}}
          />

        </M.Footer>
      {{/if}}
    </Hds::Modal>
  {{/in-element}}
{{/if}}

{{! TODO: move this out of the component }}

{{#if this.relatedResourcesAreShown}}
  <ul class="!mt-0.5 related-docs">
    {{#each-in this.relatedResources as |_resourceId resource|}}
      <li
        class="flex w-full relative group related-docs-list-item
          {{if resource.objectID 'hermes-doc' 'external-doc'}}"
      >
        <div class="w-full related-doc-link-container">
          {{#if resource.objectID}}
            <LinkTo
              @route="authenticated.document"
              @model={{resource.objectID}}
              class="related-doc-link"
            >
              <div
                class="shrink-0 p-px hds-surface-mid rounded-sm flex mt-1 overflow-hidden bg-white"
              >
                <img src="/images/document.png" class="w-5 h-auto" />
              </div>
              <div class="w-full overflow-hidden pr-6">
                <h4 class="inline-doc-title mb-0.5 truncate">
                  {{resource.title}}
                </h4>
                {{#if resource.docNumber}}
                  <div class="text-color-foreground-faint text-body-100">
                    {{resource.docNumber}}
                  </div>
                {{/if}}
              </div>
            </LinkTo>

          {{else}}
            <ExternalLink
              href={{resource.url}}
              class="related-doc-link py-0.5 flex pr-6 w-full"
            >
              <div class="flex items-center w-full">
                <div class="flex relative mr-2 w-4 h-4 shrink-0">
                  <img
                    src="https://www.google.com/s2/favicons?domain={{resource.url}}"
                    width="16"
                    height="16"
                  />
                </div>
                <div class="w-full pr-6">
                  <div class="truncate inline-doc-title">
                    {{resource.title}}
                  </div>

                  <div
                    class="truncate text-body-100 text-color-foreground-faint"
                  >
                    {{resource.displayURL}}
                  </div>
                </div>
              </div>
            </ExternalLink>
          {{/if}}

          {{! This needs to be outside the LinkTo }}
          <Inputs::DocumentSelect::MoreButton
            @removeResource={{this.removeResource}}
            @resource={{resource}}
          />
        </div>
      </li>
    {{/each-in}}
  </ul>
{{else}}
  <div class="mt-1.5 text-color-foreground-faint">
    ---
  </div>
{{/if}}
