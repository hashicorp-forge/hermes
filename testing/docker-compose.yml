# Docker Compose for Testing Environment
# 
# Purpose: Full-stack containerized environment for testing and manual QA.
#          Runs complete Hermes application (backend + frontend) with all dependencies.
#
# Usage:
#   cd testing
#   docker compose up -d --build            # Build and start all services
#   open http://localhost:4201              # Access web UI
#   docker compose logs -f hermes           # View backend logs
#   docker compose down                     # Stop and remove containers
#   docker compose down -v                  # Stop and remove containers + volumes
#
# Architecture:
#   - Uses profile-based configuration (config-profiles.hcl)
#   - Backend: Hermes server with Meilisearch + local workspace adapter
#   - Frontend: Node.js serve package serving pre-built Ember app (SPA mode)
#   - Database: PostgreSQL for persistence
#   - Search: Meilisearch for document indexing
#
# Ports (non-conflicting with integration testing):
#   - PostgreSQL: 5433 (host) -> 5432 (container)
#   - Meilisearch: 7701 (host) -> 7700 (container)
#   - Hermes API: 8001 (host) -> 8000 (container)
#   - Web UI: 4201 (host) -> 4200 (container)

services:
  postgres:
    image: postgres:17.1-alpine
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: hermes_testing
    ports:
      - "5433:5432"
    volumes:
      - postgres_testing:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - hermes-testing

  meilisearch:
    image: getmeili/meilisearch:v1.11
    environment:
      MEILI_ENV: development
      MEILI_MASTER_KEY: masterKey123
      MEILI_NO_ANALYTICS: true
    ports:
      - "7701:7700"
    volumes:
      - meilisearch_testing:/meili_data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:7700/health"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - hermes-testing

  dex:
    image: ghcr.io/dexidp/dex:v2.41.1
    container_name: hermes-dex
    ports:
      - "5558:5557"
      - "5559:5559"
    volumes:
      - ./dex-config.yaml:/etc/dex/config.yaml:ro
    command: ["dex", "serve", "/etc/dex/config.yaml"]
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5557/dex/.well-known/openid-configuration"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - hermes-testing

  hermes:
    container_name: hermes-server
    build:
      context: ..
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    volumes:
      # Mount testing configuration
      - ./config.hcl:/app/config.hcl:ro
      # Mount test users data (mirrors Dex identities)
      - ./users.json:/app/workspace_data/users.json:ro
      # Mount template documents (for document creation - seeded templates)
      - ./workspace_data/templates:/app/workspace_data/templates:ro
      # Mount workspace data (persists across restarts - runtime data)
      - hermes_workspace:/app/workspace_data
    environment:
      HERMES_BASE_URL: http://localhost:4200  # Frontend dev server port (native Ember)
      HERMES_SEARCH_PROVIDER: meilisearch
      HERMES_MEILISEARCH_URL: http://meilisearch:7700
      HERMES_MEILISEARCH_KEY: masterKey123
    command: ["server", "-config=/app/config.hcl"]
    extra_hosts:
      - "localhost:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      meilisearch:
        condition: service_healthy
      # Note: dex dependency removed - using shared Dex from root docker-compose via host.docker.internal
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://localhost:8000/health"]
      interval: 3s
      timeout: 2s
      retries: 3
      start_period: 5s
    networks:
      - hermes-testing

  web:
    container_name: hermes-web
    build:
      context: ../web
      dockerfile: Dockerfile
    ports:
      - "4201:4200"
    environment:
      # Point to the Hermes backend (container-to-container communication)
      HERMES_API_URL: http://hermes:8000
    depends_on:
      hermes:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "-O", "/dev/null", "http://127.0.0.1:4200/"]
      interval: 3s
      timeout: 2s
      retries: 3
      start_period: 5s
    networks:
      - hermes-testing

networks:
  hermes-testing:
    driver: bridge

volumes:
  postgres_testing:
  meilisearch_testing:
  hermes_workspace:
